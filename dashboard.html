<!DOCTYPE html>

<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Dashboards amb Anàlisi de Salut</title>
  <!-- tailwindcss CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
    .card { @apply bg-white rounded-xl shadow-md p-6 mb-6; }
    .view { display: none; }
    .view.active { display: block; }
    .loader { @apply border-4 border-gray-200 border-t-4 border-t-fuchsia-600 rounded-full w-6 h-6 animate-spin; }
    #sidebar { @apply transform transition-transform -translate-x-full lg:translate-x-0; }
    #sidebar.open { @apply translate-x-0; }
    .nav-link { @apply w-full text-left px-4 py-2 rounded hover:bg-slate-700 transition-colors; }
  </style>
</head>
<body class="text-slate-700">
  <!-- Sidebar -->
  <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-800 text-white p-6 z-40" aria-label="menú">
    <div class="mb-10 text-center">
      <h1 class="text-2xl font-bold">CoPsoQ <span class="text-fuchsia-400">psqcat</span></h1>
      <p class="text-sm text-slate-400">generador d'informes</p>
    </div>
    <nav>
      <ul class="space-y-2">
        <li><button data-view="dashboard" class="nav-link">dashboard</button></li>
        <li><button data-view="data-assistant" class="nav-link">assistent de dades</button></li>
        <li><button data-view="data-input" class="nav-link">guardar informe</button></li>
        <li><button data-view="reports" class="nav-link">els meus informes</button></li>
      </ul>
    </nav>
  </aside>
  <!-- Toggle button mobile -->
  <button id="nav-toggle" class="lg:hidden fixed top-4 left-4 bg-white p-2 rounded shadow z-50" aria-label="menu">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>
  <!-- Main content -->
  <main class="lg:ml-64 p-6 md:p-8">
    <section id="view-dashboard" class="view active"></section>
    <section id="view-data-assistant" class="view">
      <div class="card">
        <h2 class="text-2xl font-bold mb-2">assistent traductor de dades</h2>
        <p class="mb-4 text-slate-600">enganxa i converteix al format JSON.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
          <textarea id="raw-risk-data" class="w-full h-40 p-2 border rounded" placeholder="dades riscos..."></textarea>
          <textarea id="raw-health-data" class="w-full h-40 p-2 border rounded" placeholder="dades salut..."></textarea>
        </div>
        <button id="translate-btn" class="bg-emerald-600 text-white py-2 px-4 rounded hover:bg-emerald-700">traduir a JSON</button>
      </div>
    </section>
    <section id="view-data-input" class="view">
      <div class="card">
        <h2 class="text-2xl font-bold mb-2">guardar informe</h2>
        <input id="report-name" type="text" class="w-full p-2 mb-4 border rounded" placeholder="nom informe...">
        <textarea id="json-output" class="w-full h-40 p-2 mb-4 border rounded" readonly placeholder="JSON generat..."></textarea>
        <button id="save-btn" class="bg-fuchsia-600 text-white py-2 px-4 rounded hover:bg-fuchsia-700">guardar</button>
        <div id="save-notif" class="mt-4"></div>
      </div>
    </section>
    <section id="view-reports" class="view">
      <div class="card">
        <h2 class="text-2xl font-bold mb-4">els meus informes</h2>
        <ul id="reports-list" class="space-y-2"></ul>
      </div>
    </section>
  </main>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js';

```
// firebase setup
const config = { apiKey: 'AIzaSyBsRchId8KlzJfcaKuqeOFWPJcmopCq8V8', authDomain: 'informes-psqcat.firebaseapp.com', projectId: 'informes-psqcat' };
const app = initializeApp(config);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM refs
const views = document.querySelectorAll('.view');
const links = document.querySelectorAll('.nav-link');
const toggle = document.getElementById('nav-toggle');
const sidebar = document.getElementById('sidebar');
const notif = document.getElementById('save-notif');

let userId = null, unsubscribe = null;

// view switcher
function show(view) {
  views.forEach(v => v.classList.remove('active'));
  document.getElementById(`view-${view}`).classList.add('active');
}
links.forEach(btn => btn.addEventListener('click', () => { show(btn.dataset.view); sidebar.classList.remove('open'); }));
toggle.addEventListener('click', () => sidebar.classList.toggle('open'));

// auth
onAuthStateChanged(auth, user => {
  if (user) { userId = user.uid; loadReports(); } else { signInAnonymously(auth); }
});

// translation
document.getElementById('translate-btn').onclick = () => {
  const risk = document.getElementById('raw-risk-data').value.split('\n').map(l => l.split('\t'));
  const health = document.getElementById('raw-health-data').value;
  const dims = risk.map(p => ({ name: p[0]?.replace(/\(N=\d+\)/,''), unfavorable: parseFloat(p[1]), intermediate: parseFloat(p[2]), favorable: parseFloat(p[3]) }));
  const data = { metadata: { company: 'PSQCAT', date: new Date().toLocaleDateString() }, dimensions: dims, healthMetrics: {} };
  document.getElementById('json-output').value = JSON.stringify(data, null, 2);
  show('data-input');
};

// save
document.getElementById('save-btn').onclick = async () => {
  const name = document.getElementById('report-name').value;
  const json = document.getElementById('json-output').value;
  if (!name) return notif.innerHTML = '<p class="text-red-600">Introdueix un nom</p>';
  try { await addDoc(collection(db, `users/${userId}/reports`), { name, data: json, createdAt: new Date() }); notif.innerHTML = '<p class="text-green-600">Guardat!</p>'; } 
  catch(e){ notif.innerHTML = `<p class="text-red-600">Error: ${e.message}</p>`; }
};

// load & render reports
function loadReports() {
  if (unsubscribe) unsubscribe();
  const q = query(collection(db, `users/${userId}/reports`), orderBy('createdAt','desc'));
  unsubscribe = onSnapshot(q, snap => {
    const ul = document.getElementById('reports-list'); ul.innerHTML = '';
    snap.docs.forEach(docSnap => {
      const r = docSnap.data(); const li = document.createElement('li'); li.className = 'flex justify-between';
      li.innerHTML = `<span>${r.name}</span><div><button class="mr-2" onclick="view('${docSnap.id}', '${r.name}')">veure</button><button onclick="del('${docSnap.id}')">x</button></div>`;
      ul.appendChild(li);
    });
  });
}
window.view = (id,name) => {
  show('dashboard'); document.getElementById('view-dashboard').innerHTML = `<div class="card"><h2 class="font-bold text-xl mb-2">dashboard: ${name}</h2></div>`;
};
window.del = id => deleteDoc(doc(db, `users/${userId}/reports`, id));
```

  </script>
</body>
</html>

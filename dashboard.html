import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query } from 'firebase/firestore';

// --- Firebase Configuration ---
// This configuration is a placeholder. In a real environment, these values would be provided.
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// --- Helper Components (Icons) ---
const ChartBarIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-3"><path d="M12 20V10M18 20V4M6 20V16"/></svg>;
const InfoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-3"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
const FileTextIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>;
const UploadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-3"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>;
const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>;
const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;


// --- Main Application Components ---

const Sidebar = ({ setView, isNavOpen, setNavOpen }) => {
    const handleLinkClick = (view) => {
        setView(view);
        if (window.innerWidth < 1024) {
            setNavOpen(false);
        }
    };

    return (
        <aside className={`fixed top-0 left-0 h-full w-64 bg-slate-800 text-white p-6 overflow-y-auto z-40 lg:translate-x-0 transition-transform duration-300 ease-in-out ${isNavOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            <div className="mb-10 text-center">
                <h1 className="text-2xl font-bold">CoPsoQ <span className="text-fuchsia-400">psqcat</span></h1>
                <p className="text-sm text-slate-400">Generador de Informes</p>
            </div>
            <nav>
                <ul className="space-y-2">
                    <li><a href="#dashboard" onClick={() => handleLinkClick('dashboard')} className="flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><ChartBarIcon />Dashboard</a></li>
                    <li><a href="#data-input" onClick={() => handleLinkClick('data-input')} className="flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><UploadIcon />Introducir Datos</a></li>
                    <li><a href="#reports" onClick={() => handleLinkClick('reports')} className="flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><ListIcon />Mis Informes</a></li>
                    <li><a href="#report" onClick={() => handleLinkClick('report')} className="flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><FileTextIcon />Informe Detallado</a></li>
                    <li><a href="#info" onClick={() => handleLinkClick('info')} className="flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><InfoIcon />Acerca de</a></li>
                </ul>
            </nav>
        </aside>
    );
};

const DataInput = ({ db, userId }) => {
    const [jsonInput, setJsonInput] = useState('');
    const [reportName, setReportName] = useState('');
    const [error, setError] = useState('');
    const [success, setSuccess] = useState('');

    const handleSaveReport = async () => {
        setError('');
        setSuccess('');
        if (!reportName.trim()) {
            setError('Por favor, introduce un nombre para el informe.');
            return;
        }
        if (!userId) {
            setError('No se ha podido autenticar. Inténtalo de nuevo.');
            return;
        }

        try {
            const parsedData = JSON.parse(jsonInput);
            // Basic validation
            if (!parsedData.metadata || !parsedData.dimensions) {
                throw new Error("El formato del JSON es inválido. Faltan las claves 'metadata' o 'dimensions'.");
            }

            const reportsCollection = collection(db, `users/${userId}/reports`);
            await addDoc(reportsCollection, {
                name: reportName,
                data: JSON.stringify(parsedData), // Store data as a string
                createdAt: new Date(),
            });

            setSuccess(`¡Informe "${reportName}" guardado con éxito!`);
            setReportName('');
            setJsonInput('');
        } catch (e) {
            setError(`Error al procesar o guardar los datos: ${e.message}.`);
        }
    };

    return (
        <div className="card">
            <h2 className="text-2xl font-bold mb-4 text-slate-800">Subir Nuevo Informe</h2>
            <p className="mb-4 text-slate-600">Asigna un nombre a tu informe y pega el contenido JSON para guardarlo en tu cuenta.</p>
            
            <div className="mb-4">
                <label htmlFor="report-name" className="block text-sm font-medium text-slate-700 mb-1">Nombre del Informe:</label>
                <input
                    id="report-name"
                    type="text"
                    className="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-fuchsia-500"
                    value={reportName}
                    onChange={(e) => setReportName(e.target.value)}
                    placeholder="Ej: Informe Trimestral Q3"
                />
            </div>

            <div className="mb-4">
                <label htmlFor="json-input" className="block text-sm font-medium text-slate-700 mb-1">Datos JSON:</label>
                <textarea
                    id="json-input"
                    className="w-full h-64 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-fuchsia-500"
                    value={jsonInput}
                    onChange={(e) => setJsonInput(e.target.value)}
                    placeholder='Pega aquí tus datos en formato JSON...'
                ></textarea>
            </div>
            {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4">{error}</div>}
            {success && <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-md mb-4">{success}</div>}
            <button onClick={handleSaveReport} className="bg-fuchsia-600 text-white font-bold py-2 px-4 rounded-md hover:bg-fuchsia-700 transition-colors">
                Guardar Informe
            </button>
        </div>
    );
};

const ReportSelector = ({ reports, setSelectedReport, deleteReport }) => {
    return (
        <div className="card">
            <h2 className="text-2xl font-bold mb-4 text-slate-800">Mis Informes</h2>
            {reports.length === 0 ? (
                <p>No has subido ningún informe. Ve a "Introducir Datos" para empezar.</p>
            ) : (
                <ul className="space-y-3">
                    {reports.map(report => (
                        <li key={report.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-md hover:bg-slate-100">
                            <span className="font-medium text-slate-700">{report.name}</span>
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => setSelectedReport(report)}
                                    className="text-sm bg-sky-500 text-white py-1 px-3 rounded-md hover:bg-sky-600"
                                >
                                    Ver Dashboard
                                </button>
                                <button
                                    onClick={() => deleteReport(report.id)}
                                    className="text-sm bg-red-500 text-white p-2 rounded-md hover:bg-red-600"
                                >
                                    <TrashIcon />
                                </button>
                            </div>
                        </li>
                    ))}
                </ul>
            )}
        </div>
    );
};

const Dashboard = ({ selectedReport }) => {
    const data = useMemo(() => {
        if (!selectedReport) return null;
        try {
            return JSON.parse(selectedReport.data);
        } catch (e) {
            console.error("Failed to parse report data:", e);
            return null;
        }
    }, [selectedReport]);

    if (!data) {
        return (
            <div className="card text-center">
                <h2 className="text-2xl font-bold text-slate-800">Bienvenido</h2>
                <p className="mt-2 text-slate-600">No hay ningún informe seleccionado. Por favor, ve a "Mis Informes" para elegir uno.</p>
            </div>
        );
    }
    
    const topRisks = [...data.dimensions].sort((a, b) => b.unfavorable - a.unfavorable).slice(0, 5);
    const mainRisk = topRisks[0];
    const mostFavorable = [...data.dimensions].sort((a, b) => b.favorable - a.favorable)[0];
    const responseRate = (data.metadata.participants / data.metadata.totalSurveyed) * 100;

    return (
        <div>
            <h2 className="text-2xl font-bold mb-4 text-slate-800">Dashboard: <span className="text-fuchsia-600">{selectedReport.name}</span></h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                 <div className="card"><p className="text-sm text-slate-500">Tasa de Respuesta</p><p className="text-2xl font-bold">{responseRate.toFixed(1)}%</p></div>
                 <div className="card"><p className="text-sm text-slate-500">Principal Riesgo</p><p className="text-xl font-bold">{mainRisk?.name} ({mainRisk?.unfavorable}%)</p></div>
                 <div className="card"><p className="text-sm text-slate-500">Dimensión Favorable</p><p className="text-xl font-bold">{mostFavorable?.name} ({mostFavorable?.favorable}%)</p></div>
            </div>
            {/* Charts would be rendered here using a library like Chart.js */}
            <div className="card text-center text-slate-500">
                [Visualización de Gráficos para el informe: {selectedReport.name}]
            </div>
        </div>
    );
};


// --- Main App Component ---

export default function App() {
    const [view, setView] = useState('dashboard');
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [reports, setReports] = useState([]);
    const [selectedReport, setSelectedReport] = useState(null);
    const [isNavOpen, setNavOpen] = useState(false);

    // Initialize Firebase and Auth
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const firestore = getFirestore(app);
            setDb(firestore);

            onAuthStateChanged(auth, user => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
    }, []);

    // Listen for reports from Firestore
    useEffect(() => {
        if (db && userId) {
            const reportsCollection = collection(db, `users/${userId}/reports`);
            const q = query(reportsCollection);
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const reportsData = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                setReports(reportsData);
            }, (error) => {
                console.error("Error fetching reports:", error);
            });

            // Cleanup subscription on unmount
            return () => unsubscribe();
        }
    }, [db, userId]);

    const deleteReport = async (reportId) => {
        if (!db || !userId) return;
        if (window.confirm("¿Estás seguro de que quieres eliminar este informe?")) {
            const reportDoc = doc(db, `users/${userId}/reports`, reportId);
            await deleteDoc(reportDoc);
            if(selectedReport && selectedReport.id === reportId) {
                setSelectedReport(null); // Deselect if the current one is deleted
            }
        }
    };

    const renderView = () => {
        switch (view) {
            case 'dashboard': return <Dashboard selectedReport={selectedReport} />;
            case 'data-input': return <DataInput db={db} userId={userId} />;
            case 'reports': return <ReportSelector reports={reports} setSelectedReport={setSelectedReport} deleteReport={deleteReport} />;
            case 'report': return <div>Informe Detallado (Vista en construcción)</div>;
            case 'info': return <div>Acerca de (Vista en construcción)</div>;
            default: return <Dashboard selectedReport={selectedReport} />;
        }
    };

    return (
        <div className="bg-slate-100 min-h-screen">
            <Sidebar setView={setView} isNavOpen={isNavOpen} setNavOpen={setNavOpen} />
            <button onClick={() => setNavOpen(!isNavOpen)} className="lg:hidden fixed top-4 left-4 z-50 bg-white p-2 rounded-md shadow-lg">
                <MenuIcon />
            </button>
            <main className="lg:ml-64 p-6 md:p-8">
                {renderView()}
            </main>
        </div>
    );
}

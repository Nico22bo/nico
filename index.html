<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Dashboards amb Anàlisi de Salut (Versió Definitiva)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; }
        .view { display: none; }
        .view.active { display: block; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #c026d3; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #sidebar { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        #sidebar.open { transform: translateX(0); }
        @media (min-width: 1024px) { #sidebar { transform: translateX(0); } }
        .prose h4 { font-size: 1.125rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose ul { list-style-position: inside; }
        .prose li { margin-left: 1rem; }
        /* Estilos para el modal de confirmación */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 60;
        }
    </style>
</head>
<body class="text-slate-700">

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-slate-800 text-white p-6 overflow-y-auto z-40">
        <div class="mb-10 text-center">
            <h1 class="text-2xl font-bold">CoPsoQ <span class="text-fuchsia-400">psqcat</span></h1>
            <p class="text-sm text-slate-400">Generador d'Informes</p>
        </div>
        <nav>
            <ul class="space-y-2" id="nav-links">
                <li><a href="#dashboard" data-view="dashboard" class="nav-link flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 20V10M18 20V4M6 20V16"/></svg>Dashboard</a></li>
                <li><a href="#data-assistant" data-view="data-assistant" class="nav-link flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 2a10 10 0 00-9.95 9.5c.05.59.41 1.05.95 1.05h18c.54 0 .9-.46.95-1.05A10 10 0 0012 2z"/><path d="M12 12v10M12 2L4.5 4.5M12 2l7.5 2.5"/></svg>Assistent de Dades</a></li>
                <li><a href="#data-input" data-view="data-input" class="nav-link flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Guardar Informe</a></li>
                <li><a href="#reports" data-view="reports" class="nav-link flex items-center p-2 rounded-md hover:bg-slate-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Els Meus Informes</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Mobile Nav Toggle -->
    <button id="nav-toggle" class="lg:hidden fixed top-4 left-4 z-50 bg-white p-2 rounded-md shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
    </button>

    <!-- Main Content -->
    <main class="lg:ml-64 p-6 md:p-8">
        <div id="view-dashboard" class="view active"><div id="dashboard-content"></div></div>
        <div id="view-data-assistant" class="view"><div class="card"><h2 class="text-2xl font-bold mb-2">Assistent Traductor de Dades</h2><p class="mb-4 text-slate-600">Aquesta eina t'ajuda a convertir les dades del teu informe a un format compatible.</p><div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert"><p class="font-bold">Instruccions</p><ol class="list-decimal list-inside mt-2"><li>Obre el teu informe PSQCAT.</li><li>Copia el text de la taula de riscos i la de salut.</li><li>Enganxa cada text al seu quadre corresponent.</li><li>Fes clic a "Traduir a JSON".</li></ol></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="mb-4"><label for="raw-risk-data-input" class="block text-sm font-medium">1. Enganxa aquí les dades de **Riscos**</label><textarea id="raw-risk-data-input" class="w-full h-64 p-2 border rounded-md" placeholder="Ex: Exigències quantitatives (N=87)	50,5747	34,4828	14,9425"></textarea></div><div class="mb-4"><label for="raw-health-data-input" class="block text-sm font-medium">2. Enganxa aquí les dades de **Salut i Benestar**</label><textarea id="raw-health-data-input" class="w-full h-64 p-2 border rounded-md" placeholder="Ex: Salut general de..."></textarea></div></div><button id="translate-btn" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-md hover:bg-emerald-700">3. Traduir a JSON</button></div></div>
        <div id="view-data-input" class="view"><div class="card"><h2 class="text-2xl font-bold mb-4">Guardar Nou Informe</h2><p class="mb-4 text-slate-600">Revisa les dades generades, assigna un nom a l'informe i guarda'l.</p><div class="mb-4"><label for="report-name" class="block text-sm font-medium">1. Nom de l'Informe (Obligatori)</label><input id="report-name" type="text" class="w-full p-2 border border-slate-300 rounded-md" placeholder="Ej: Informe IDIAP 2024"></div><div class="mb-4"><label for="json-input" class="block text-sm font-medium">2. Dades JSON (Generades per l'assistent)</label><textarea id="json-input" class="w-full h-64 p-2 border rounded-md" placeholder="Les dades traduïdes apareixeran aquí..."></textarea></div><div id="notification-area" class="mb-4"></div><button id="save-report-btn" class="bg-fuchsia-600 text-white font-bold py-2 px-4 rounded-md hover:bg-fuchsia-700">3. Guardar Informe</button></div></div>
        <div id="view-reports" class="view"><div class="card"><h2 class="text-2xl font-bold mb-4">Els Meus Informes</h2><ul id="reports-list" class="space-y-3"></ul></div></div>
    </main>

    <!-- Modal de Confirmación para Borrar -->
    <div id="delete-modal" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-slate-800">Confirmar Eliminació</h3>
            <p class="text-slate-600 mt-2">Estàs segur que vols eliminar aquest informe? Aquesta acció no es pot desfer.</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">Cancel·lar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase SDK actualizadas
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // Variables globales de la aplicación
            let db, auth, userId, selectedReport = null, reportsUnsubscribe = null, reportToDeleteId = null;
            const charts = {};
            
            // Variable appId obligatoria para las rutas de Firestore
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Referencias a elementos del DOM
            const DOM = {
                views: document.querySelectorAll('.view'),
                navLinks: document.querySelectorAll('.nav-link'),
                dashboardContent: document.getElementById('dashboard-content'),
                reportsList: document.getElementById('reports-list'),
                saveReportBtn: document.getElementById('save-report-btn'),
                reportNameInput: document.getElementById('report-name'),
                jsonInput: document.getElementById('json-input'),
                notificationArea: document.getElementById('notification-area'),
                rawRiskDataInput: document.getElementById('raw-risk-data-input'),
                rawHealthDataInput: document.getElementById('raw-health-data-input'),
                translateBtn: document.getElementById('translate-btn'),
                navToggle: document.getElementById('nav-toggle'),
                sidebar: document.getElementById('sidebar'),
                deleteModal: document.getElementById('delete-modal'),
                confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
                cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            };

            // Función para cambiar entre vistas (Dashboard, Asistente, etc.)
            function switchView(viewId) {
                DOM.views.forEach(view => view.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                if (viewId === 'dashboard') renderDashboard();
            }

            // --- MANEJADORES DE EVENTOS ---
            DOM.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(e.currentTarget.dataset.view);
                    if (window.innerWidth < 1024) DOM.sidebar.classList.remove('open');
                });
            });
            DOM.navToggle.addEventListener('click', () => DOM.sidebar.classList.toggle('open'));
            DOM.translateBtn.addEventListener('click', translatePastedData);
            DOM.saveReportBtn.addEventListener('click', saveReport);
            DOM.cancelDeleteBtn.addEventListener('click', () => DOM.deleteModal.classList.add('hidden'));
            DOM.confirmDeleteBtn.addEventListener('click', () => {
                if (reportToDeleteId) {
                    performDelete(reportToDeleteId);
                    reportToDeleteId = null;
                }
                DOM.deleteModal.classList.add('hidden');
            });

            // --- LÓGICA DE TRADUCCIÓN DE DATOS ---
            function translatePastedData() {
                const riskText = DOM.rawRiskDataInput.value;
                const healthText = DOM.rawHealthDataInput.value;
                
                if (!riskText.trim()) {
                    renderNotification("Si us plau, enganxa el text de la taula de riscos.", 'error');
                    return;
                }
                
                try {
                    const dimensions = parseDimensions(riskText);
                    const healthMetrics = parseHealthMetrics(healthText);

                    if (dimensions.length === 0) {
                        throw new Error("No s'han pogut extreure dimensions de risc. Assegura't de copiar les línies amb el format correcte.");
                    }

                    const psqcatData = {
                        metadata: { company: "Informe Traduït", date: new Date().toLocaleDateString(), participants: 100, totalSurveyed: 100 },
                        dimensions: dimensions,
                        healthMetrics: healthMetrics,
                        conclusions: { summary: "Dades generades des de l'assistent." }
                    };
                    
                    DOM.jsonInput.value = JSON.stringify(psqcatData, null, 2);
                    renderNotification("Dades traduïdes a JSON amb èxit. Ara pots anomenar i guardar l'informe.", 'success');
                    switchView('data-input');
                } catch (e) {
                    renderNotification("Error en traduir les dades: " + e.message, 'error');
                    console.error(e);
                }
            }

            function parseDimensions(text) {
                const dimensions = [];
                const lines = text.split('\n').filter(line => line.trim() !== '' && !line.toLowerCase().includes('més desfavorable'));
                
                lines.forEach(line => {
                    const parts = line.split('\t');
                    if (parts.length >= 4) {
                        let name = parts[0].replace(/\(N=\d+\)/, '').trim();
                        if (name && isNaN(parseFloat(name))) {
                            dimensions.push({
                                name: name,
                                unfavorable: parseFloat(String(parts[1]).replace(',', '.')),
                                intermediate: parseFloat(String(parts[2]).replace(',', '.')),
                                favorable: parseFloat(String(parts[3]).replace(',', '.'))
                            });
                        }
                    }
                });
                return dimensions;
            }

            // **NUEVO MOTOR DE ANÁLISIS DE DATOS DE SALUD - MÁS ROBUSTO**
            function parseHealthMetrics(text) {
                const metrics = {
                    generalhealth: {}, satisfaction: {}, stress: {}, burnout: {}, salutmental: {}
                };
                if (!text.trim()) return metrics;

                const metricKeywords = {
                    'salut general de': 'generalhealth',
                    'salut mental de': 'salutmental',
                    'estrès de': 'stress',
                    'burnout de': 'burnout',
                    'satisfacció de': 'satisfaction'
                };

                const ageKeywords = {
                    'menys de 31 anys': 'under31',
                    'entre 31 - 45 anys': 'between31_45',
                    'més de 45 anys': 'over45'
                };
                
                const splitter = new RegExp(`(?=^(${Object.keys(metricKeywords).join('|')}))`, 'gim');
                const blocks = text.split(splitter).filter(s => s.trim());

                blocks.forEach(block => {
                    const lines = block.split('\n').map(l => l.trim()).filter(Boolean);
                    if (lines.length === 0) return;

                    const firstLineLower = lines[0].toLowerCase();
                    let currentMetricKey = null;
                    
                    for (const keyword in metricKeywords) {
                        if (firstLineLower.startsWith(keyword)) {
                            currentMetricKey = metricKeywords[keyword];
                            break;
                        }
                    }
                    
                    if (!currentMetricKey) return;

                    let currentGroupKey = '';
                    
                    lines.forEach(line => {
                        const lowerLine = line.toLowerCase();

                        if (['tots', 'dones', 'homes'].includes(lowerLine)) {
                            currentGroupKey = lowerLine;
                            if (!metrics[currentMetricKey][currentGroupKey]) {
                                metrics[currentMetricKey][currentGroupKey] = {};
                            }
                            return;
                        }

                        for (const ageKeyword in ageKeywords) {
                            if (lowerLine.startsWith(ageKeyword)) {
                                const ageKey = ageKeywords[ageKeyword];
                                const parts = line.split(/\s{2,}|	/);
                                const values = parts.slice(1).map(v => parseFloat(v.replace(',', '.'))).filter(v => !isNaN(v));
                                
                                if (currentGroupKey && values.length > 0) {
                                    if (!metrics[currentMetricKey][currentGroupKey]) {
                                        metrics[currentMetricKey][currentGroupKey] = {};
                                    }
                                    metrics[currentMetricKey][currentGroupKey][ageKey] = values;
                                }
                                return;
                            }
                        }
                    });
                });
                return metrics;
            }

            // --- RENDERIZADO DEL DASHBOARD ---
            function renderDashboard() {
                if (!selectedReport) {
                    DOM.dashboardContent.innerHTML = `<div class="card text-center"><h2 class="text-2xl font-bold">Benvingut</h2><p class="mt-2">No hi ha cap informe seleccionat. Ves a "Els Meus Informes" per triar-ne un.</p></div>`;
                    return;
                }
                try {
                    const data = JSON.parse(selectedReport.data);
                    const problematic = data.dimensions.filter(d => d.unfavorable > 50).sort((a,b) => b.unfavorable - a.unfavorable);
                    const improvable = data.dimensions.filter(d => d.unfavorable >= 33.3 && d.unfavorable <= 49.9).sort((a,b) => b.unfavorable - a.unfavorable);
                    const favorable = data.dimensions.filter(d => d.favorable > 33.3).sort((a,b) => b.favorable - a.favorable);

                    DOM.dashboardContent.innerHTML = `
                        <h2 class="text-3xl font-bold mb-2">Dashboard: <span class="text-fuchsia-600">${selectedReport.name}</span></h2>
                        <p class="text-slate-500 mb-6">Empresa: ${data.metadata.company} - Data: ${data.metadata.date}</p>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            ${createRiskCard("Exposicions Problemàtiques", problematic, 'bg-red-100', 'text-red-700', 'unfavorable')}
                            ${createRiskCard("Exposicions Millorables", improvable, 'bg-yellow-100', 'text-yellow-700', 'unfavorable')}
                            ${createRiskCard("Exposicions Favorables", favorable, 'bg-green-100', 'text-green-700', 'favorable')}
                        </div>
                        <div class="card mb-8">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <h3 class="text-2xl font-bold">Salut i Benestar</h3>
                                <div class="flex items-center gap-2">
                                    <label for="age-filter" class="text-sm font-medium">Filtre per Edat:</label>
                                    <select id="age-filter" class="p-1 border rounded-md text-sm">
                                        <option value="tots">Tots</option>
                                        <option value="under31">Menys de 31 anys</option>
                                        <option value="between31_45">Entre 31 - 45 anys</option>
                                        <option value="over45">Més de 45 anys</option>
                                    </select>
                                </div>
                            </div>
                            <div id="health-charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="card">
                                <h3 class="text-2xl font-bold mb-4">Model Demanda-Control (Karasek)</h3>
                                <svg viewBox="0 0 400 300" class="w-full h-auto">${getKarasekModelSVG(data)}</svg>
                            </div>
                            <div class="card">
                                 <h3 class="text-2xl font-bold mb-4">Anàlisi i Recomanacions d'IA</h3>
                                 <div id="conclusions-content" class="text-slate-600 space-y-2 prose max-w-none">
                                     <p>Fes clic al botó per generar una anàlisi i recomanacions basades en les dades d'aquest informe.</p>
                                 </div>
                                 <button id="generate-conclusions-btn" class="mt-4 bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center gap-2 disabled:opacity-50">
                                     <span id="btn-text">Generar Anàlisi amb IA</span>
                                     <div id="btn-loader" class="loader hidden"></div>
                                 </button>
                            </div>
                        </div>
                    `;
                    renderHealthCharts(data, 'tots');
                    document.getElementById('age-filter').addEventListener('change', (e) => renderHealthCharts(data, e.target.value));
                    document.getElementById('generate-conclusions-btn').addEventListener('click', () => generateConclusions(data));
                } catch (e) {
                    DOM.dashboardContent.innerHTML = `<div class="card text-red-600">Error en processar les dades de l'informe: ${e.message}</div>`;
                    console.error(e);
                }
            }
            
            function createRiskCard(title, dimensions, bgColor, textColor, valueKey) {
                return `<div class="card"><h4 class="font-bold text-lg mb-3 ${textColor}">${title}</h4><ul class="space-y-2 text-sm">${dimensions.map(d => `<li class="flex justify-between items-center"><span>${d.name}</span><span class="font-semibold ${textColor} ${bgColor} px-2 py-1 rounded-md">${d[valueKey].toFixed(1)}%</span></li>`).join('') || '<li>No hi ha dimensions en aquesta categoria.</li>'}</ul></div>`;
            }

            function renderHealthCharts(data, ageGroupKey) {
                const container = document.getElementById('health-charts-container');
                container.innerHTML = '';
                Object.values(charts).forEach(chart => chart.destroy());
                
                if (!data.healthMetrics) return;

                const metrics = [
                    { key: 'generalhealth', title: 'Salut General', labels: ['Regular/Dolenta', 'Bona', 'Excel·lent/Bona'] },
                    { key: 'salutmental', title: 'Salut Mental', labels: ['Superior', 'Mitjà', 'Inferior'] },
                    { key: 'stress', title: 'Estrès', labels: ['Nivell Baix (Verd)', 'Nivell Mitjà (Groc)', 'Nivell Alt (Vermell)'] },
                    { key: 'burnout', title: 'Burnout', labels: ['Nivell Baix (Verd)', 'Nivell Mitjà (Groc)', 'Nivell Alt (Vermell)'] },
                    { key: 'satisfaction', title: 'Satisfacció', labels: ['Molt Satisfet', 'Satisfet', 'Insatisfet', 'Molt Insatisfet'] }
                ];

                metrics.forEach(metric => {
                    const metricData = data.healthMetrics[metric.key];
                    if (!metricData || (Object.keys(metricData).length === 0)) return;

                    let donesData = [], homesData = [];
                    
                    if (ageGroupKey === 'tots') {
                        const ageKeys = ['under31', 'between31_45', 'over45'];
                        const numCategories = metric.labels.length;
                        for(let i=0; i < numCategories; i++) {
                            let donesSum = 0, donesCount = 0;
                            let homesSum = 0, homesCount = 0;
                            ageKeys.forEach(ageKey => {
                                if (metricData.dones && metricData.dones[ageKey] && metricData.dones[ageKey][i] !== undefined) {
                                    donesSum += metricData.dones[ageKey][i];
                                    donesCount++;
                                }
                                if (metricData.homes && metricData.homes[ageKey] && metricData.homes[ageKey][i] !== undefined) {
                                    homesSum += metricData.homes[ageKey][i];
                                    homesCount++;
                                }
                            });
                            donesData.push(donesCount > 0 ? donesSum / donesCount : 0);
                            homesData.push(homesCount > 0 ? homesSum / homesCount : 0);
                        }
                    } else {
                        donesData = (metricData.dones && metricData.dones[ageGroupKey]) ? metricData.dones[ageGroupKey] : [];
                        homesData = (metricData.homes && metricData.homes[ageGroupKey]) ? metricData.homes[ageGroupKey] : [];
                    }

                    if (donesData.length === 0 && homesData.length === 0) return;

                    const card = document.createElement('div');
                    card.innerHTML = `<h4 class="text-lg font-semibold text-center mb-2">${metric.title}</h4><canvas id="${metric.key}-chart"></canvas>`;
                    container.appendChild(card);

                    charts[metric.key] = new Chart(document.getElementById(`${metric.key}-chart`).getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: metric.labels,
                            datasets: [
                                { label: 'Dones', data: donesData, backgroundColor: 'rgba(219, 39, 119, 0.7)', borderWidth: 1 },
                                { label: 'Homes', data: homesData, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderWidth: 1 }
                            ]
                        },
                        options: { responsive: true, indexAxis: 'y', plugins: { legend: { position: 'bottom' } }, scales: { x: { suggestedMax: 100, beginAtZero: true } } }
                    });
                });
            }
            
            function getKarasekModelSVG(data) {
                const demandaDims = ["exigències quantitatives", "ritme de treball", "exigències emocionals", "exigències d'amagar emocions"];
                const controlDims = ["influència", "possibilitats de desenvolupament", "sentit del treball"];
                
                const getAvg = (dims, key) => {
                    const filtered = data.dimensions.filter(d => dims.includes(d.name.toLowerCase()));
                    if (filtered.length === 0) return 0;
                    const total = filtered.reduce((acc, curr) => acc + curr[key], 0);
                    return total / filtered.length;
                };

                const demandaScore = getAvg(demandaDims, 'unfavorable');
                const controlScore = getAvg(controlDims, 'favorable');

                let x = 300, y = 80; // Default: Alta Tensión (Alta Demanda, Bajo Control)
                if (demandaScore < 50 && controlScore >= 50) { x = 100; y = 220; } // Baja Tensión
                if (demandaScore >= 50 && controlScore >= 50) { x = 100; y = 80; } // Activo
                if (demandaScore < 50 && controlScore < 50) { x = 300; y = 220; } // Pasivo

                return `<g fill="none" stroke="#334155" stroke-width="1"><path d="M200 0 V300 M0 150 H400"/></g><g text-anchor="middle" font-size="14" font-family="Inter, sans-serif"><text x="100" y="80" fill="#059669">Treball Actiu</text><text x="300" y="220" fill="#dc2626">Treball Passiu</text><text x="300" y="80" fill="#ef4444">Alta Tensió</text><text x="100" y="220" fill="#65a30d">Baixa Tensió</text><text x="200" y="140" font-weight="bold">CONTROL</text><text x="30" y="155" transform="rotate(-90 30 155)" font-weight="bold">DEMANDA</text><g stroke="#c026d3" stroke-width="2" fill="#c026d3" fill-opacity="0.2"><rect x="${x-40}" y="${y-30}" width="80" height="60" rx="10"/><text x="${x}" y="${y+5}" fill="#c026d3" font-size="12" font-weight="bold">Equip</text></g></g>`;
            }
            
            // --- LÓGICA DE IA ---
            async function generateConclusions(data) {
                const conclusionsContent = document.getElementById('conclusions-content');
                const genButton = document.getElementById('generate-conclusions-btn');
                const btnLoader = document.getElementById('btn-loader');
                const btnText = document.getElementById('btn-text');

                btnLoader.classList.remove('hidden');
                btnText.textContent = 'Generant...';
                genButton.disabled = true;

                const dimensionsText = data.dimensions.map(d => `- ${d.name}: ${d.unfavorable}% desfavorable`).join('\n');
                const prompt = `Ets un expert consultor en prevenció de riscos laborals i salut organitzacional, especialitzat en el mètode CoPsoQ PSQCAT i el model Demanda-Control de Karasek. Analitza les següents dades d'un informe per a l'empresa ${data.metadata.company}. Les dades són:\n\n**DADES DE RISCOS PSICOSOCIALS (Percentatge d'exposició desfavorable):**\n${dimensionsText}\n\nBasat en aquest conjunt de dades, redacta una anàlisi professional i accionable en català. L'estructura ha de ser la següent:\n\n**1. Anàlisi segons el Model Demanda-Control (Karasek):**\nIndica a quin quadrant se situa l'equip (ex. "Alta Tensió", "Treball Actiu", etc.) basant-te en les puntuacions d'exigències (demanda) i control (influència, desenvolupament). Explica què implica aquesta situació per a l'equip.\n\n**2. Àrees Crítiques d'Intervenció (Factors de Risc Alts):**\nLlista les dimensions amb els percentatges d'exposició desfavorable més alts (superiors al 50%). Per a cadascuna, explica breument què significa aquest risc a la pràctica.\n\n**3. Punts Forts i Factors Protectors:**\nLlista les dimensions amb millors resultats (més favorables). Explica per què són importants i com es poden fer servir com a palanca per millorar altres àrees.\n\n**4. Pla d'Acció Recomanat:**\nUna secció final amb recomanacions clares i específiques. Indica on ha d'actuar l'empresa. Per a les 2-3 àrees més crítiques, proposa 1-2 accions concretes i pràctiques que la direcció pot implementar.\n\nEl to ha de ser constructiu, professional i orientat a solucions. Formata la resposta usant Markdown amb títols (##), llistes amb guions (-) i negretes (**).`;

                try {
                    const apiKey = ""; // Canvas proporcionará la clave
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Error de l'API: ${response.statusText}`);

                    const result = await response.json();
                    const analysisText = result.candidates[0].content.parts[0].text;
                    
                    conclusionsContent.innerHTML = analysisText
                        .replace(/## (.*?)\n/g, '<h4 class="font-bold text-lg mt-4 mb-2">$1</h4>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/- (.*?)(?=\n- |\n<br>|$)/g, '<li class="ml-4 list-disc">$1</li>')
                        .replace(/\n/g, '<br>');

                } catch (error) {
                    conclusionsContent.innerHTML = `<p class="text-red-600">Error en generar l'anàlisi: ${error.message}</p>`;
                } finally {
                    btnLoader.classList.add('hidden');
                    btnText.textContent = 'Generar Anàlisi amb IA';
                    genButton.disabled = false;
                }
            }

            // --- LÓGICA DE FIRESTORE ---
            async function saveReport() {
                const name = DOM.reportNameInput.value.trim();
                const json = DOM.jsonInput.value.trim();
                if (!name) { renderNotification("Introdueix un nom per a l'informe.", 'error'); return; }
                if (!userId) { renderNotification("No s'ha pogut autenticar. Recarrega la pàgina.", 'error'); return; }
                try {
                    const parsedData = JSON.parse(json);
                    if (!parsedData.metadata || !parsedData.dimensions) throw new Error("Format JSON invàlid.");
                    const collectionPath = `artifacts/${appId}/users/${userId}/reports`;
                    await addDoc(collection(db, collectionPath), { name, data: json, createdAt: new Date().toISOString() });
                    renderNotification(`Informe "${name}" guardat.`, 'success');
                    DOM.reportNameInput.value = '';
                    DOM.jsonInput.value = '';
                    switchView('reports');
                } catch (e) {
                    renderNotification(`Error en guardar: ${e.message}`, 'error');
                }
            }

            function requestDelete(reportId) {
                reportToDeleteId = reportId;
                DOM.deleteModal.classList.remove('hidden');
            }

            async function performDelete(reportId) {
                if (!db || !userId) return;
                try {
                    const docPath = `artifacts/${appId}/users/${userId}/reports/${reportId}`;
                    await deleteDoc(doc(db, docPath));
                    if (selectedReport && selectedReport.id === reportId) {
                        selectedReport = null;
                        renderDashboard();
                    }
                } catch(e) {
                    renderNotification(`Error en eliminar: ${e.message}`, 'error');
                }
            }

            function listenToReports() {
                if (reportsUnsubscribe) reportsUnsubscribe();
                if (!userId) return;
                const collectionPath = `artifacts/${appId}/users/${userId}/reports`;
                const q = query(collection(db, collectionPath)); // No se usa orderBy para evitar errores de índice
                reportsUnsubscribe = onSnapshot(q, (snapshot) => {
                    const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Ordenar en el cliente
                    reports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    renderReportsList(reports);
                }, (error) => {
                    console.error("Error en escoltar informes: ", error);
                    renderNotification("No s'han pogut carregar els informes.", "error");
                });
            }

            function renderReportsList(reports) {
                DOM.reportsList.innerHTML = reports.length === 0 
                    ? '<p>No has pujat cap informe.</p>'
                    : reports.map(report => `
                        <li class="flex items-center justify-between p-3 bg-slate-50 rounded-md">
                            <span class="font-medium">${report.name}</span>
                            <div class="flex items-center gap-2">
                                <button data-report-id="${report.id}" class="view-dashboard-btn text-sm bg-sky-500 text-white py-1 px-3 rounded-md hover:bg-sky-600">Veure</button>
                                <button data-report-id="${report.id}" class="delete-report-btn text-sm bg-red-500 text-white p-2 rounded-md hover:bg-red-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                </button>
                            </div>
                        </li>`).join('');
                
                // Re-asignar eventos después de renderizar
                document.querySelectorAll('.view-dashboard-btn').forEach(btn => btn.onclick = (e) => {
                    selectedReport = reports.find(r => r.id === e.currentTarget.dataset.reportId);
                    switchView('dashboard');
                });
                document.querySelectorAll('.delete-report-btn').forEach(btn => btn.onclick = (e) => requestDelete(e.currentTarget.dataset.reportId));
            }


            // --- INICIALIZACIÓN ---
            function renderNotification(message, type = 'success') {
                const color = type === 'success' ? 'green' : 'red';
                const notification = document.createElement('div');
                notification.className = `bg-${color}-100 border border-${color}-400 text-${color}-700 px-4 py-3 rounded-md mb-4`;
                notification.textContent = message;
                DOM.notificationArea.prepend(notification);
                setTimeout(() => notification.remove(), 5000);
            }

            async function init() {
                // Usar la configuración de Firebase proporcionada por el entorno
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

                if (!firebaseConfig) {
                    console.error("Firebase config is not available.");
                    DOM.dashboardContent.innerHTML = `<div class="card text-red-600">Error de configuració. No s'ha pogut inicialitzar l'aplicació.</div>`;
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    setLogLevel('debug'); // Habilitar logs para depuración

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            listenToReports();
                        } else {
                            // Intentar login con token personalizado, si no, anónimo
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (token) {
                                try {
                                    await signInWithCustomToken(auth, token);
                                } catch (e) {
                                    console.error("Custom token sign-in failed, falling back to anonymous", e);
                                    await signInAnonymously(auth);
                                }
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });
                    renderDashboard();
                } catch (error) {
                    console.error("Firebase init failed:", error);
                    DOM.dashboardContent.innerHTML = `<div class="card text-red-600">Error d'inicialització. Comprova la consola per a més detalls.</div>`;
                }
            }

            init();
        });
    </script>
</body>
</html>
